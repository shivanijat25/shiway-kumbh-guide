<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Interactive Map ‚Äì Shiway</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<style>
    #map {
        height: 70vh;
        width: 100%;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-heavy);
        position: relative;
    }

    .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .map-control-btn {
        background: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        box-shadow: var(--shadow-medium);
        transition: var(--transition);
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .map-control-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: scale(1.05);
    }

    .map-control-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-medium);
        z-index: 1000;
        min-width: 200px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    .legend-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .search-box {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        width: 300px;
    }

    .location-info {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        margin-top: 20px;
        box-shadow: var(--shadow-light);
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 20px;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .filter-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    @media (max-width: 768px) {
        .search-box {
            position: relative;
            top: auto;
            right: auto;
            width: 100%;
            margin-bottom: 20px;
        }

        .map-legend {
            position: relative;
            bottom: auto;
            right: auto;
            margin-top: 20px;
        }

        .map-controls {
            position: relative;
            top: auto;
            left: auto;
            flex-direction: row;
            justify-content: center;
            margin-bottom: 20px;
        }
    }
</style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="assets/logo.png" alt="Shiway Logo" height="40" class="me-2" />
            <span class="fw-bold">SHIWAY</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="shahi-snan.html"><i class="fas fa-calendar-alt me-1"></i>Shahi Snan</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="map.html"><i class="fas fa-map me-1"></i>Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="emergency.html"><i class="fas fa-phone-alt me-1"></i>Emergency</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Hero -->
<div class="page-hero">
    <div class="container">
        <img src="assets/logo.png" alt="Shiway Logo" />
        <h1><i class="fas fa-map-marked-alt me-3"></i>Interactive Map</h1>
        <p>Navigate the mela grounds with real-time locations and services</p>

        <!-- Quick Stats -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="stat-card glass-effect text-center p-3 rounded">
                    <div class="stat-number text-white">4</div>
                    <div class="stat-label text-white-50">Shahi Snan Spots</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card glass-effect text-center p-3 rounded">
                    <div class="stat-number text-white">6</div>
                    <div class="stat-label text-white-50">Food Stations</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card glass-effect text-center p-3 rounded">
                    <div class="stat-number text-white">5</div>
                    <div class="stat-label text-white-50">Traffic Alerts</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card glass-effect text-center p-3 rounded">
                    <div class="stat-number text-white">4</div>
                    <div class="stat-label text-white-50">Emergency Services</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container mt-5 mb-5">
    <!-- Map Controls and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-filter me-2"></i>Map Filters
                    </h5>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">
                            <i class="fas fa-globe me-1"></i>Show All
                        </button>
                        <button class="filter-btn" data-filter="shahi">
                            <i class="fas fa-calendar-alt me-1"></i>Shahi Snan
                        </button>
                        <button class="filter-btn" data-filter="food">
                            <i class="fas fa-utensils me-1"></i>Food Stations
                        </button>
                        <button class="filter-btn" data-filter="traffic">
                            <i class="fas fa-traffic-light me-1"></i>Traffic Alerts
                        </button>
                        <button class="filter-btn" data-filter="emergency">
                            <i class="fas fa-ambulance me-1"></i>Emergency
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Box for Mobile -->
    <div class="row mb-3 d-md-none">
        <div class="col-12">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="mobileSearchBox" placeholder="Search locations...">
                <button class="btn btn-primary" onclick="searchLocation()">Search</button>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="row">
        <div class="col-12">
            <div class="position-relative">
                <!-- Desktop Search Box -->
                <div class="search-box d-none d-md-block">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchBox" placeholder="Search locations...">
                        <button class="btn btn-primary" onclick="searchLocation()">Search</button>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="map-controls d-none d-md-flex">
                    <button class="map-control-btn" onclick="centerOnUser()" title="My Location">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button class="map-control-btn" onclick="toggleTraffic()" title="Toggle Traffic" id="trafficBtn">
                        <i class="fas fa-traffic-light"></i>
                    </button>
                    <button class="map-control-btn" onclick="toggleSatellite()" title="Satellite View" id="satelliteBtn">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button class="map-control-btn" onclick="fullscreenMap()" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>

                <!-- Map -->
                <div id="map">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">Loading interactive map...</p>
                        </div>
                    </div>
                </div>

                <!-- Map Legend -->
                <div class="map-legend d-none d-md-block">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Legend</h6>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #FF6B35; color: white;">üìÖ</div>
                        <span>Shahi Snan Spots</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #06D6A0; color: white;">üçõ</div>
                        <span>Food Stations</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #C73E1D; color: white;">‚ö†Ô∏è</div>
                        <span>Traffic Alerts</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #667eea; color: white;">üö®</div>
                        <span>Emergency Services</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #4285F4; color: white;">üìç</div>
                        <span>Your Location</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Legend -->
    <div class="row mt-3 d-md-none">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-info-circle me-2"></i>Map Legend</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #FF6B35; color: white;">üìÖ</div>
                                <small>Shahi Snan</small>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #06D6A0; color: white;">üçõ</div>
                                <small>Food Stations</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #C73E1D; color: white;">‚ö†Ô∏è</div>
                                <small>Traffic Alerts</small>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #667eea; color: white;">üö®</div>
                                <small>Emergency</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Map Controls -->
    <div class="row mt-3 d-md-none">
        <div class="col-12">
            <div class="map-controls">
                <button class="map-control-btn" onclick="centerOnUser()" title="My Location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="map-control-btn" onclick="toggleTraffic()" title="Toggle Traffic" id="mobileTrafficBtn">
                    <i class="fas fa-traffic-light"></i>
                </button>
                <button class="map-control-btn" onclick="toggleSatellite()" title="Satellite View" id="mobileSatelliteBtn">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="map-control-btn" onclick="fullscreenMap()" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Location Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="location-info" id="locationInfo" style="display: none;">
                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Location Details</h5>
                <div id="locationDetails">
                    <!-- Location details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">
                        <i class="fas fa-compass me-2"></i>Navigation Tools
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="findNearestFood()">
                                <i class="fas fa-utensils me-2"></i>Nearest Food
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100" onclick="findNearestGhat()">
                                <i class="fas fa-water me-2"></i>Nearest Ghat
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100" onclick="checkTrafficRoute()">
                                <i class="fas fa-route me-2"></i>Best Route
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-danger w-100" onclick="findEmergencyServices()">
                                <i class="fas fa-ambulance me-2"></i>Emergency
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-4">
                <div class="footer-brand">
                    <img src="assets/logo.png" alt="Shiway Logo" height="40" />
                    <h5>SHIWAY</h5>
                    <p>Your trusted companion for Simhastha Kumbh Mela</p>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="footer-links">
                    <h6>Quick Links</h6>
                    <ul>
                        <li><a href="shahi-snan.html">Shahi Snan</a></li>
                        <li><a href="food-stations.html">Food Facilities</a></li>
                        <li><a href="map.html">Interactive Map</a></li>
                        <li><a href="emergency.html">Emergency Help</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="footer-contact">
                    <h6>Emergency Contact</h6>
                    <p><i class="fas fa-phone"></i> +91-9999999999</p>
                    <p><i class="fas fa-envelope"></i> help@shiway.com</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2028 Shiway Project ‚Äì Smart Simhastha Guide. Made with ‚ù§Ô∏è for pilgrims.</p>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFwlmFRICBhPeVtNZt3VByj76xMzoq-SA&libraries=places"></script>
<script src="data.js"></script>
<script src="script.js"></script>

<script>
// Enhanced map functionality
let map;
let markers = {
    shahi: [],
    food: [],
    traffic: [],
    emergency: [],
    user: null
};
let trafficLayer;
let isTrafficVisible = false;
let isSatelliteView = false;
let infoWindow;

// Initialize enhanced map
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 23.1822, lng: 75.7777 },
        zoom: 14,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
    });

    infoWindow = new google.maps.InfoWindow();
    trafficLayer = new google.maps.TrafficLayer();

    // Initialize all markers
    createAllMarkers();

    // Setup filter functionality
    setupMapFilters();

    // Get user location
    getUserLocation();

    // Setup search functionality
    setupMapSearch();
}

function createAllMarkers() {
    // Clear existing markers
    clearAllMarkers();

    // Create Shahi Snan markers
    data.shahiSnan.forEach(item => {
        const marker = createCustomMarker(item, 'shahi', 'üìÖ', '#FF6B35');
        markers.shahi.push(marker);
    });

    // Create Food Station markers
    data.foodStations.forEach(item => {
        const marker = createCustomMarker(item, 'food', 'üçõ', '#06D6A0');
        markers.food.push(marker);
    });

    // Create Traffic markers
    data.traffic.forEach(item => {
        const marker = createCustomMarker(item, 'traffic', '‚ö†Ô∏è', '#C73E1D');
        markers.traffic.push(marker);
    });

    // Create Emergency markers
    data.emergency.forEach(item => {
        const marker = createCustomMarker(item, 'emergency', 'üö®', '#667eea');
        markers.emergency.push(marker);
    });
}

function createCustomMarker(item, type, emoji, color) {
    const marker = new google.maps.Marker({
        position: { lat: item.lat, lng: item.lng },
        map: map,
        title: item.name || item.info,
        icon: {
            url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                    <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
                    <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">${emoji}</text>
                </svg>
            `)}`,
            scaledSize: new google.maps.Size(40, 40),
            anchor: new google.maps.Point(20, 20)
        },
        animation: google.maps.Animation.DROP
    });

    marker.addListener('click', () => {
        showLocationInfo(item, type);
        infoWindow.setContent(createInfoWindowContent(item, type));
        infoWindow.open(map, marker);
    });

    return marker;
}

function createInfoWindowContent(item, type) {
    let content = `<div class="p-3" style="min-width: 250px;">`;

    switch (type) {
        case 'shahi':
            content += `
                <h6 class="mb-2">${item.name}</h6>
                <p class="mb-1"><strong>Address:</strong> ${item.address}</p>
                <p class="mb-1"><strong>Date:</strong> ${item.date}</p>
                <p class="mb-2"><strong>Time:</strong> ${item.time}</p>
                <button class="btn btn-sm btn-primary" onclick="getDirections(${item.lat}, ${item.lng})">
                    <i class="fas fa-directions me-1"></i>Get Directions
                </button>
            `;
            break;
        case 'food':
            const isOpen = checkIfOpen(item.availability);
            content += `
                <h6 class="mb-2">${item.name}</h6>
                <p class="mb-1"><strong>Address:</strong> ${item.address}</p>
                <p class="mb-1"><strong>Available:</strong> ${item.availability}</p>
                <p class="mb-2">
                    <span class="badge ${isOpen ? 'bg-success' : 'bg-secondary'}">
                        ${isOpen ? 'Open Now' : 'Closed'}
                    </span>
                </p>
                <button class="btn btn-sm btn-primary me-2" onclick="getDirections(${item.lat}, ${item.lng})">
                    <i class="fas fa-directions me-1"></i>Directions
                </button>
                <button class="btn btn-sm btn-success" onclick="shareLocation('${item.name}', ${item.lat}, ${item.lng})">
                    <i class="fas fa-share me-1"></i>Share
                </button>
            `;
            break;
        case 'traffic':
            content += `
                <h6 class="mb-2">Traffic Alert</h6>
                <p class="mb-2">${item.info}</p>
                <button class="btn btn-sm btn-warning" onclick="findAlternateRoute(${item.lat}, ${item.lng})">
                    <i class="fas fa-route me-1"></i>Find Alternate Route
                </button>
            `;
            break;
        case 'emergency':
            content += `
                <h6 class="mb-2">Emergency Service</h6>
                <p class="mb-2">${item.info}</p>
                <div class="d-flex gap-2">
                    <a href="tel:${item.contact}" class="btn btn-sm btn-danger">
                        <i class="fas fa-phone me-1"></i>Call ${item.contact}
                    </a>
                    <button class="btn btn-sm btn-primary" onclick="getDirections(${item.lat}, ${item.lng})">
                        <i class="fas fa-directions me-1"></i>Directions
                    </button>
                </div>
            `;
            break;
    }

    content += `</div>`;
    return content;
}

function setupMapFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Filter markers
            const filter = btn.dataset.filter;
            filterMarkers(filter);
        });
    });
}

function filterMarkers(filter) {
    // Hide all markers first
    Object.values(markers).forEach(markerArray => {
        if (Array.isArray(markerArray)) {
            markerArray.forEach(marker => marker.setVisible(false));
        }
    });

    // Show selected markers
    if (filter === 'all') {
        Object.values(markers).forEach(markerArray => {
            if (Array.isArray(markerArray)) {
                markerArray.forEach(marker => marker.setVisible(true));
            }
        });
    } else {
        markers[filter].forEach(marker => marker.setVisible(true));
    }

    // Always show user marker
    if (markers.user) {
        markers.user.setVisible(true);
    }
}

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };

            if (markers.user) {
                markers.user.setMap(null);
            }

            markers.user = new google.maps.Marker({
                position: userPos,
                map: map,
                title: "Your Location",
                icon: {
                    url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                            <circle cx="15" cy="15" r="12" fill="#4285F4" stroke="white" stroke-width="3"/>
                            <circle cx="15" cy="15" r="4" fill="white"/>
                        </svg>
                    `)}`,
                    scaledSize: new google.maps.Size(30, 30),
                    anchor: new google.maps.Point(15, 15)
                }
            });

            map.setCenter(userPos);
            currentLocation = userPos;
        });
    }
}

function centerOnUser() {
    if (markers.user) {
        map.setCenter(markers.user.getPosition());
        map.setZoom(16);
    } else {
        getUserLocation();
    }
}

function toggleTraffic() {
    const btns = [document.getElementById('trafficBtn'), document.getElementById('mobileTrafficBtn')];

    if (isTrafficVisible) {
        trafficLayer.setMap(null);
        btns.forEach(btn => btn && btn.classList.remove('active'));
        isTrafficVisible = false;
    } else {
        trafficLayer.setMap(map);
        btns.forEach(btn => btn && btn.classList.add('active'));
        isTrafficVisible = true;
    }
}

function toggleSatellite() {
    const btns = [document.getElementById('satelliteBtn'), document.getElementById('mobileSatelliteBtn')];

    if (isSatelliteView) {
        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
        btns.forEach(btn => btn && btn.classList.remove('active'));
        isSatelliteView = false;
    } else {
        map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
        btns.forEach(btn => btn && btn.classList.add('active'));
        isSatelliteView = true;
    }
}

function fullscreenMap() {
    const mapElement = document.getElementById('map');
    if (mapElement.requestFullscreen) {
        mapElement.requestFullscreen();
    } else if (mapElement.webkitRequestFullscreen) {
        mapElement.webkitRequestFullscreen();
    } else if (mapElement.msRequestFullscreen) {
        mapElement.msRequestFullscreen();
    }
}

function setupMapSearch() {
    const searchBoxes = [document.getElementById('searchBox'), document.getElementById('mobileSearchBox')];

    searchBoxes.forEach(searchBox => {
        if (searchBox) {
            const autocomplete = new google.maps.places.Autocomplete(searchBox);
            autocomplete.bindTo('bounds', map);

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(16);
                }
            });
        }
    });
}

function searchLocation() {
    const searchTerm = document.getElementById('searchBox')?.value || document.getElementById('mobileSearchBox')?.value;
    if (!searchTerm) return;

    // Search in our data
    const allLocations = [
        ...data.shahiSnan,
        ...data.foodStations,
        ...data.emergency
    ];

    const found = allLocations.find(location =>
        (location.name && location.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (location.address && location.address.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    if (found) {
        map.setCenter({ lat: found.lat, lng: found.lng });
        map.setZoom(16);
        showNotification(`Found: ${found.name || found.info}`, 'success');
    } else {
        showNotification('Location not found', 'warning');
    }
}

function getDirections(lat, lng) {
    const destination = `${lat},${lng}`;
    const url = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
    window.open(url, '_blank');
}

function findNearestFood() {
    if (!currentLocation) {
        showNotification('Please enable location access', 'warning');
        return;
    }

    let nearest = null;
    let minDistance = Infinity;

    data.foodStations.forEach(station => {
        const distance = calculateDistance(currentLocation.lat, currentLocation.lng, station.lat, station.lng);
        if (distance < minDistance) {
            minDistance = distance;
            nearest = station;
        }
    });

    if (nearest) {
        map.setCenter({ lat: nearest.lat, lng: nearest.lng });
        map.setZoom(16);
        showNotification(`Nearest food station: ${nearest.name} (${minDistance.toFixed(1)} km away)`, 'success');
    }
}

function findNearestGhat() {
    if (!currentLocation) {
        showNotification('Please enable location access', 'warning');
        return;
    }

    let nearest = null;
    let minDistance = Infinity;

    data.shahiSnan.forEach(ghat => {
        const distance = calculateDistance(currentLocation.lat, currentLocation.lng, ghat.lat, ghat.lng);
        if (distance < minDistance) {
            minDistance = distance;
            nearest = ghat;
        }
    });

    if (nearest) {
        map.setCenter({ lat: nearest.lat, lng: nearest.lng });
        map.setZoom(16);
        showNotification(`Nearest ghat: ${nearest.name} (${minDistance.toFixed(1)} km away)`, 'success');
    }
}

function checkTrafficRoute() {
    if (!isTrafficVisible) {
        toggleTraffic();
    }
    showNotification('Traffic layer enabled. Red areas indicate heavy traffic.', 'info');
}

function findEmergencyServices() {
    // Filter to show only emergency markers
    document.querySelector('[data-filter="emergency"]').click();
    showNotification('Showing all emergency services', 'info');
}

function findAlternateRoute(lat, lng) {
    showNotification('Opening Google Maps for alternate route suggestions', 'info');
    getDirections(lat, lng);
}

function showLocationInfo(item, type) {
    const locationInfo = document.getElementById('locationInfo');
    const locationDetails = document.getElementById('locationDetails');

    let content = '';

    switch (type) {
        case 'shahi':
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>${item.name}</h6>
                        <p><strong>Address:</strong> ${item.address}</p>
                        <p><strong>Date:</strong> ${item.date}</p>
                        <p><strong>Time:</strong> ${item.time}</p>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-sm me-2" onclick="getDirections(${item.lat}, ${item.lng})">
                            <i class="fas fa-directions me-1"></i>Get Directions
                        </button>
                        <button class="btn btn-success btn-sm" onclick="shareLocation('${item.name}', ${item.lat}, ${item.lng})">
                            <i class="fas fa-share me-1"></i>Share
                        </button>
                    </div>
                </div>
            `;
            break;
        case 'food':
            const isOpen = checkIfOpen(item.availability);
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>${item.name}</h6>
                        <p><strong>Address:</strong> ${item.address}</p>
                        <p><strong>Available:</strong> ${item.availability}</p>
                        <p>
                            <span class="badge ${isOpen ? 'bg-success' : 'bg-secondary'}">
                                ${isOpen ? 'Open Now' : 'Closed'}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-sm me-2" onclick="getDirections(${item.lat}, ${item.lng})">
                            <i class="fas fa-directions me-1"></i>Directions
                        </button>
                        <button class="btn btn-success btn-sm" onclick="shareLocation('${item.name}', ${item.lat}, ${item.lng})">
                            <i class="fas fa-share me-1"></i>Share
                        </button>
                    </div>
                </div>
            `;
            break;
    }

    locationDetails.innerHTML = content;
    locationInfo.style.display = 'block';
}

function clearAllMarkers() {
    Object.values(markers).forEach(markerArray => {
        if (Array.isArray(markerArray)) {
            markerArray.forEach(marker => marker.setMap(null));
        }
    });

    markers = {
        shahi: [],
        food: [],
        traffic: [],
        emergency: [],
        user: markers.user
    };
}

// Initialize map when page loads
window.onload = initMap;
</script>
</body>
</html>
